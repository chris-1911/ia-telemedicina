# -*- coding: utf-8 -*-
"""servidor_ia

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lmvZ0sINHSSwP_cIm9bizj82D3XUI3lv
"""

# servidor_ia.py
import requests
from fastapi import FastAPI
from pydantic import BaseModel
import os

#  Token personal de Hugging Face (solo lectura)
HUGGINGFACE_TOKEN = os.getenv("HUGGINGFACE_TOKEN")

#  Inicializar la app FastAPI
app = FastAPI(title="Servidor IA Telemedicina", version="1.0")

# З Estructura de los datos recibidos desde Flutter
class Solicitud(BaseModel):
    diagnostico: str
    probabilidad: float
    sintomas: list[str]

#  Endpoint principal
@app.post("/explicar")
def explicar(data: Solicitud):
    # Si la predicci贸n tiene baja confianza
    if data.probabilidad < 0.9:
        return {
            "estado": "incertidumbre",
            "mensaje": (
                f"La predicci贸n tuvo solo {data.probabilidad*100:.1f}% de confianza. "
                "Se recomienda agregar m谩s s铆ntomas o consultar a un m茅dico."
            )
        }

    # Construir el prompt
    prompt = (
        f"Paciente con {', '.join(data.sintomas)}.\n"
        f"Diagn贸stico probable: {data.diagnostico} ({data.probabilidad*100:.1f}% de certeza).\n"
        "Eres un asistente m茅dico emp谩tico y profesional. Explica brevemente "
        "qu茅 es esta enfermedad, sus causas comunes y los cuidados iniciales recomendados "
        "en lenguaje sencillo y humano:\n"
    )

    # Encabezados de autenticaci贸n
    headers = {
        "Authorization": f"Bearer {HUGGINGFACE_TOKEN}",
        "Content-Type": "application/json"
    }

    # Cuerpo seg煤n formato actualizado (2025)
    payload = {
        "inputs": [
            {
                "role": "user",
                "content": prompt
            }
        ],
        "parameters": {
            "max_new_tokens": 150,
            "temperature": 0.7
        }
    }

    # Llamar a Hugging Face API
    try:
        response = requests.post(
          "https://router.huggingface.co/hf-inference/v1/models/mistralai/Mistral-7B-Instruct-v0.3",
            headers=headers,
            json=payload,
            timeout=90
        )

        # Si todo sale bien
        if response.status_code == 200:
            data = response.json()

            # Detectar tipo de estructura en la respuesta
            if isinstance(data, list) and len(data) > 0:
                if "generated_text" in data[0]:
                    text = data[0]["generated_text"]
                elif "content" in data[0] and len(data[0]["content"]) > 0:
                    text = data[0]["content"][0].get("text", "")
                else:
                    text = str(data)
            elif isinstance(data, dict):
                text = data.get("generated_text", str(data))
            else:
                text = str(data)

            return {"estado": "exito", "explicacion": text.strip()}

        # Si Hugging Face devuelve error (401, 404, 503, etc.)
        else:
            return {
                "estado": "error",
                "mensaje": f"Error {response.status_code}: {response.text}"
            }

    except Exception as e:
        # Cualquier error de red/DNS/timeouts
        return {"estado": "error", "mensaje": f"Excepci贸n: {str(e)}"}