# -*- coding: utf-8 -*-
"""servidor_ia

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lmvZ0sINHSSwP_cIm9bizj82D3XUI3lv
"""

# servidor_ia.py  — versión Google Gemini 1.5 Flash 2.5
from fastapi import FastAPI
from pydantic import BaseModel
import google.generativeai as genai
import os

app = FastAPI(title="Servidor IA Telemedicina - Gemini 1.5 Flash 2.5")

# Configurar la API key desde variable de entorno
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))

class Solicitud(BaseModel):
    diagnostico: str
    probabilidad: float
    sintomas: list[str]

@app.post("/explicar")
def explicar(data: Solicitud):
    # Si la predicción es poco confiable
    if data.probabilidad < 0.9:
        return {
            "estado": "incertidumbre",
            "mensaje": (
                f"La predicción tuvo solo {data.probabilidad*100:.1f}% de confianza. "
                "Se recomienda agregar más síntomas o consultar a un médico."
            )
        }

    # Prompt que se envía al modelo
    prompt = f"""
    Paciente con {', '.join(data.sintomas)}.
    Diagnóstico probable: {data.diagnostico} ({data.probabilidad*100:.1f}% de certeza).
    Eres un asistente médico empático y profesional.
    Explica qué es esta enfermedad, sus causas comunes y cuidados iniciales
    en lenguaje claro y comprensible para el paciente.
    """

    try:
        # Crear el modelo (versión actual de Google)
        model = genai.GenerativeModel("gemini-1.5-flash-latest")  # última versión estable
        respuesta = model.generate_content(prompt)
        return {
            "estado": "exito",
            "explicacion": respuesta.text.strip()
        }
    except Exception as e:
        return {"estado": "error", "mensaje": f"Excepción: {str(e)}"}